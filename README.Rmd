---
title: "Transmission analysis"
author: "Karim"
output:
  html_document: default
---

### **1. data quality control**     
This includes SNPs filtration based on their MAF (minor allele frequencies), their percentage of missing genotypes (missingness) as well as the filtration of isolates based on missingness.    
&nbsp;&nbsp;&nbsp;&nbsp;**Function name:** _Filter_data.R_    
&nbsp;&nbsp;&nbsp;&nbsp;**Parameters:**    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the input VCF file. This should be filtered on MQ, VQSLOD, DP_     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the MAF cut-off_     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the missingness cut-off_     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the path to the folder where to store the output files_    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the numder of threads_    
&nbsp;&nbsp;&nbsp;&nbsp;**Outputs:** _2 `pdf` files (plots of SNPs and isolates missingness and MAF) and a text file named `MyGenotype.txt`_       
&nbsp;&nbsp;&nbsp;&nbsp;**Example:**        
```{bash eval = FALSE}
Rscript Filter_data.R ./Data/file.vcf.gz 0.01 20 ./Results/ 15      
```

***         

### **2. estimation of the complexity of infection (COI)**
The input VCF file will be filtered so that it contains only the SNPs and isolates that have passed the QC step. The filtered VCF file is then used to compute Fws (within sample fixation index) using the `moimix` R package.   
&nbsp;&nbsp;&nbsp;&nbsp;**Function name:** _Compute_COI.R_    
&nbsp;&nbsp;&nbsp;&nbsp;**Parameters:**    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the filtered genotype file_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the input VCF file_    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the sample metadata file_    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the file that contains the order in which you wish your population to be shown in the output plot, 1 population per line_        
&nbsp;&nbsp;&nbsp;&nbsp;**Outputs:** _the filtered VCF file (file with a prefix `Passed_QC_genotypes`), 2 `pdf` files (Fws plots)_       
&nbsp;&nbsp;&nbsp;&nbsp;**Example:**        
```{bash eval = FALSE}
Rscript Compute_COI.R ./Results/MyGenotype.txt ./Data/MyDelgeme4.vcf.gz ./Data/SampleMetadata.txt ./Data/Pop_Order.txt    
```

***  

### **3. construction of the input files for relatedness inference ** 
11 regions of the genome that are associated with drug resistance are first discarded. Then the reference alleles are recoded as `0`, the alternate alleles as `1`. We defined 3 methods of recoding the mixed genotypes:   
&nbsp;&nbsp;&nbsp;&nbsp; mixed genotypes replaced by the minor allele calculated across all samples for a given SNPs (`minor_David`)   
&nbsp;&nbsp;&nbsp;&nbsp; mixed genotypes considered as a third allele and recoded as 2 (`raw`)    
&nbsp;&nbsp;&nbsp;&nbsp; mixed genotypes replaced by the minor allele calculated based on the allelic depth on a given isolates at a particular SNP (`minor_Karim`)   
Note that for the first and third method, when the frequencies of the 2 alleles are the same, it is recoded based on a Bernoulli distribution.   
&nbsp;&nbsp;&nbsp;&nbsp;**Function name:** _Construct_Genotype_File.R_    
&nbsp;&nbsp;&nbsp;&nbsp;**Parameters:**    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the filtered VCF file_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the output files directory_    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the file with sample metadata file_    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _full path to the file with genomic locations of the regions to be discarded_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the mixed genotypes recoding method _    
&nbsp;&nbsp;&nbsp;&nbsp;**Outputs:** _creates `RDS` files with the recoded genotype data, 1 for each population_    
&nbsp;&nbsp;&nbsp;&nbsp;**Example:**           
```{bash eval = FALSE}
Rscript Construct_Genotype_File.R ./Results/Passed_QC_genotypes.vcf.gz ./Results/GenotypeFiles Data/SampleMetadata.txt ./Data/Resistance_Gene.txt raw   
```

***  

### **4. Inference of relatedness between all pairs of populations ** 
We estimated relatedness between pairs of isolates from 2 distinct populations based on the method proposed by Aimee Taylor and Coauthors https://journals.plos.org/plosgenetics/article?id=10.1371/journal.pgen.1009101   
Between every pairs of population, the relatedness is evaluated using data from 5 MAF cut-offs (set of SNPs with MAF>0%, MAF>10%, MAF>20%, MAF>30%, MAF>40%)   
Before running this stage, make sure the `runSim.sh` is edited according to your HPC specifications.   
&nbsp;&nbsp;&nbsp;&nbsp;**Function name:** _Run_Relatedness.R_    
&nbsp;&nbsp;&nbsp;&nbsp;**Parameters:**    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the folder with the recoded data_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the output files directory_    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the file with population order_    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the mixed genotypes recoding method_     
&nbsp;&nbsp;&nbsp;&nbsp;**Outputs:** _creates `RDS` files within different folders, 1 for each pair of populations_    
&nbsp;&nbsp;&nbsp;&nbsp;**Example:**        
```{bash eval = FALSE}
Rscript Run_Relatedness.R ./Results/Raw_Genotypes ./Results/IBD_folder ./Data/Pop_Order.txt raw      
```

***  

### **5. Summarizing the relatedness files from each pairs of populations ** 
When estimating relatedness, pairs of samples from 2 populations are splitted and stored into separated RDS files. Here, we will concatenate these files and form one RDS file for each MAF cut-off.  
&nbsp;&nbsp;&nbsp;&nbsp;**Function name:** _Summarize_IBD_Files.R_    
&nbsp;&nbsp;&nbsp;&nbsp;**Parameters:**    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the input folder_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the output files directory_    
&nbsp;&nbsp;&nbsp;&nbsp;**Outputs:** _creates `RDS` files within output folders_    
&nbsp;&nbsp;&nbsp;&nbsp;**Example:**        
```{bash eval = FALSE}
Rscript Summarize_IBD_Files.R ./Results/IBD_folder/From_raw_Data ./Results/IBD_folder/From_raw_Data/Summarized  
```

***

### **6. Determination of the percentage of highly related infections pairs **   
We set a relatedness cut-off (in our case, we varied the cut-off from 0.2 to 0.6 by step of 0.1) and considered any pairs of infection with a relatedness value greater than or equal to this cut-off as a highly related pair of infections. If your samples were collected in different years, the relatedness data will be summarized in a way that for pair of populations, relatedness values will be reported between the different sampling years.  
&nbsp;&nbsp;&nbsp;&nbsp;**Function name:** _Identify_HRPI.R_    
&nbsp;&nbsp;&nbsp;&nbsp;**Parameters:**    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the folder with the summarized data_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the file with the sample metadata file_    
&nbsp;&nbsp;&nbsp;&nbsp;**Outputs:** _creates several `RDS` files within output folders. Among these, will be interested in the once with a suffix `_All_Pairs.RDS`_        
&nbsp;&nbsp;&nbsp;&nbsp;**Example:**          
```{bash eval = FALSE}
Rscript Identify_HRPI.R ./Results/IBD_folder/From_raw_Data/Summarized ./Data/SampleMetadata.txt  
```

***

### **7. Combine relatedness files **    
Files from the above step (6) will be combined into one single file that will be used for the subsequent analysis. Note that the combined output file is a list of 5 data frames that contain the same information. You can chose any of them for the next stages.    
&nbsp;&nbsp;&nbsp;&nbsp;**Function name:** _Combine_Relatedness_Files.R_    
&nbsp;&nbsp;&nbsp;&nbsp;**Parameters:**    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the folder with the summarized data_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the file with the physical distances between the sampling sites_    
&nbsp;&nbsp;&nbsp;&nbsp;**Outputs:** _creates `RDS` files within a folder named `Combined/`_    
&nbsp;&nbsp;&nbsp;&nbsp;**Example:**        
```{bash eval = FALSE}
Rscript Combine_Relatedness_Files.R ./Results/IBD_folder/From_raw_Data/Summarized ./Data/PhysicalDistanceBetweenLocations.txt    
```


***

### **8. Analysis section **  

###### **8.1. Fws by region **
```{r echo = FALSE, eval = TRUE}
suppressPackageStartupMessages(require(data.table))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(rstatix))
suppressPackageStartupMessages(require(ggpubr))


#----- determining the proportion of monoclonal isolates by location
transmissionDir = "/Users/km28/Documents/Karim/Karim/Gitlab/Transmission"
myFws = fread(paste0(transmissionDir,"/Fws_COI.txt"))
#note that with the new version this should be replaced by the line below
#myFws = readRDS(paste0(transmissionDir,"/Fws_COI.RDS"))
myFws$status="polyclonal"
myFws[which(myFws$Fws>0.95),]$status='monoclonal'
message("Percentage of monoclonal isolates: ",nrow(myFws[which(myFws$Fws>0.95),])/nrow(myFws))
t = table(myFws$Location, myFws$status)
t = as.matrix(t)
pmono = round((t[,1]/rowSums(t))*100, 3); ppoly = round((t[,2]/rowSums(t))*100, 3)
t = cbind(t, pmono, ppoly)
colnames(t) = c('#monoclonal','#polyclonal','%monoclonal','%polyclonal')
saveRDS(t, paste0(transmissionDir,'/','Populations_COI_Status.RDS'))
sites = rep(rownames(t),2)
ps = c(t[,3],t[,4])
st = c(rep('monoclonal',nrow(t)), rep('polyclonal',nrow(t)))
data = data.frame(cbind(sites,ps, st))
names(data)=c('location','proportion','state')
p=ggplot(data, aes(fill=state, y=proportion, x=location)) + 
    geom_bar(position="dodge", stat="identity")
pdf(paste0(transmissionDir,'/','Populations_COI_Status.pdf'))
print(p)
dev.off()


# --- comparing mean Fws between regions
myFws$regions = "Senegal"
myFws[which(myFws$Location=='Brikama' | myFws$Location=='Besse'),]$regions='Western'
myFws[which(myFws$Location=='Basse' | myFws$Location=='Njayel' | myFws$Location=='SareWuro'),]$regions='Eastern'
myFws[which(myFws$Location=='Serrekunda' | myFws$Location=='Farafenni'),]$regions='Ancient'
myFws[which(myFws$Location=='DongoroBa' | myFws$Location=='Chogen'),]$regions='Central'
myFws$regions = as.factor(myFws$regions)
myFws$Fws = as.numeric(myFws$Fws)
myFws$regions = factor(myFws$regions, levels = c("Western", "Central", "Eastern", "Ancient", "Senegal"))
# note that we will consider the adjusted p-values 
stat.test = myFws %>% wilcox_test(Fws ~ regions, p.adjust.method = "bonferroni")
saveRDS(stat.test, "/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/Fws_Stat_ByRegion.RDS")
bxp = ggboxplot(myFws, x="regions", y="Fws", fill = "regions",
                palette = c("#00AFBB", "black", "#FC4E07", "#E7B800","gray"),
                ylab = "Fws", xlab = "regions") +
    stat_pvalue_manual(
        stat.test, label = "p.adj.signif", tip.length = 0.01,
        y.position = c(1.1, 1.2, 1.5,1.6,1.1,1.3,1.4,1.1,1.2,1.1), bracket.shorten = 0.05
    ) +
  theme(axis.text.x = element_text(face="plain", color="black", angle = 60, hjust = 1, size=6), #, size=14
        axis.text.y = element_text(face="plain", color="black", size=6),
        legend.position = "none",
        axis.line = element_line(color = 'black', size = 0.5, linetype = 'solid')) #, size=14

    # theme(axis.text.x = element_text(angle = 60, hjust = 1))
pdf(paste0(transmissionDir,"/Fws_Stat_ByRegion.pdf"))
print(bxp)
dev.off()

myFws$Location=factor(myFws$Location, levels = c("Thies","Serrekunda","Brikama","Besse","Chogen","Bounkiling","Farafenni","DongoroBa","Basse","SareWuro","Njayel"))
ggplot(myFws, aes(x=Location, y=Fws, fill=Location)) + 
    geom_boxplot(outlier.size = 0.1) +
    scale_fill_manual(values=c('gray', 'gray','gray','gray','gray','gray','gray','gray','gray','gray','gray')) +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", angle = 60, hjust = 1, size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid"),
        legend.position = "none"
    )
```

###### **8.2. get the file to use for analysis    

```{r echo = FALSE, eval = TRUE}
relatednessDir="/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/RelatednessFolder"
#for raw data 
#---
#In this directory, 'Between_Pop_Combined_0.6.RDS' is the relatedness file between locations, No within location relatedness
#'Combined_0.6.RDS' is the file with all relatedness including within population
#---
#relatednessDir="/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/RelatednessFolder"
system(sprintf("mkdir -p %s", relatednessDir)) 
relatedness = readRDS(paste0(relatednessDir,"/Combined_0.6_From_Raw.RDS"))   
allPairs_From_Raw = relatedness[[1]]   
saveRDS(allPairs_From_Raw, paste0(relatednessDir,"/All_Relatedness_From_Raw.RDS"))  
rm(relatedness)

#for minor_David data  
relatedness = readRDS(paste0(relatednessDir,"/Combined_0.6_From_minor_David.RDS"))   
allPairs_From_minor_David = relatedness[[1]]   
saveRDS(allPairs_From_minor_David, paste0(relatednessDir,"/All_Relatedness_From_Minor_David.RDS")) 

#for minor_Karim data   
relatedness = readRDS(paste0(relatednessDir,"/Combined_0.6_From_Minor_Karim.RDS"))   
allPairs_From_Raw = relatedness[[1]]   
saveRDS(allPairs_From_Raw, paste0(relatednessDir,"/All_Relatedness_From_Minor_Karim.RDS")) 
```

###### **8.3. determining MAF cut-off (by comparing the results from the different mixed genotypes recoding methods against the results from raw data)   

```{r echo = FALSE, eval = FALSE}
suppressPackageStartupMessages(require(data.table))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(pheatmap))
relatednessDir="/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/RelatednessFolder"
raw = readRDS(paste0(relatednessDir,"/All_Relatedness_From_Raw.RDS"))    
minorDavid = readRDS(paste0(relatednessDir,"/All_Relatedness_From_Minor_David.RDS"))    
minorKarim = readRDS(paste0(relatednessDir,"/All_Relatedness_From_Minor_Karim.RDS"))  
#--- X will be the matrix of mean relatedness for every MAF cut-off
X = matrix(0, 3, 5)
rownames(X) = c("raw", "method1", "method2")
colnames(X) = c("MAF>0%","MAF>10%","MAF>20%","MAF>30%","MAF>40%")
X[1,1] = mean(as.numeric(raw$`rMaf>0`), na.rm = TRUE)
X[1,2] = mean(as.numeric(raw$`rMaf>10`), na.rm = TRUE)
X[1,3] = mean(as.numeric(raw$`rMaf>20`), na.rm = TRUE)
X[1,4] = mean(as.numeric(raw$`rMaf>30`), na.rm = TRUE)
X[1,5] = mean(as.numeric(raw$`rMaf>40`), na.rm = TRUE)

X[2,1] = mean(as.numeric(minorDavid$`rMaf>0`), na.rm = TRUE)
X[2,2] = mean(as.numeric(minorDavid$`rMaf>10`), na.rm = TRUE)
X[2,3] = mean(as.numeric(minorDavid$`rMaf>20`), na.rm = TRUE)
X[2,4] = mean(as.numeric(minorDavid$`rMaf>30`), na.rm = TRUE)
X[2,5] = mean(as.numeric(minorDavid$`rMaf>40`), na.rm = TRUE)

X[3,1] = mean(as.numeric(minorKarim$`rMaf>0`), na.rm = TRUE)
X[3,2] = mean(as.numeric(minorKarim$`rMaf>10`), na.rm = TRUE)
X[3,3] = mean(as.numeric(minorKarim$`rMaf>20`), na.rm = TRUE)
X[3,4] = mean(as.numeric(minorKarim$`rMaf>30`), na.rm = TRUE)
X[3,5] = mean(as.numeric(minorKarim$`rMaf>40`), na.rm = TRUE)

pdf(paste0(paste0(relatednessDir,"/Heatmap_r_maf_recodingMethod.pdf")))
pheatmap(X, cluster_cols = FALSE, cluster_rows = FALSE, fontsize = 6)
dev.off()

saveRDS(X, paste0(relatednessDir,"/Mean_relatedness_by_recoding_method_and_Maf_cutoff.RDS"))

#between raw and minorDavid
raw = as.data.table(raw); setkeyv(raw,c('iid1','iid2'))  
minorDavid = as.data.table(minorDavid); setkeyv(minorDavid,c('iid1','iid2'))     
joined = raw[minorDavid, nomatch=0]  
joined$`rMaf>0` = as.numeric(joined$`rMaf>0`)       
joined$`i.rMaf>0` = as.numeric(joined$`i.rMaf>0`)      
p1 = ggplot(joined, aes(x=joined$`rMaf>0`, y=joined$`i.rMaf>0`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method1; MAF>0%; correlation coefficient=",round(cor(joined$`rMaf>0`, joined$`i.rMaf>0`), digits = 2))) +
    xlab("raw") +ylab("method1") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")
    ) #+
    # theme(axis.line = element_line(color = 'black', size = 0.5, linetype = 'solid'))
    
joined$`rMaf>10` = as.numeric(joined$`rMaf>10`)       
joined$`i.rMaf>10` = as.numeric(joined$`i.rMaf>10`)      
p2 = ggplot(joined, aes(x=joined$`rMaf>10`, y=joined$`i.rMaf>10`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method1; MAF>10%; correlation coefficient=",round(cor(joined$`rMaf>10`, joined$`i.rMaf>10`), digits = 2))) +
    # xlab("raw") +ylab("method1") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")
    ) #+
    # theme(axis.line = element_line(color = 'black', size = 0.5, linetype = 'solid'))
    
joined$`rMaf>20` = as.numeric(joined$`rMaf>20`)       
joined$`i.rMaf>20` = as.numeric(joined$`i.rMaf>20`)      
p3 = ggplot(joined, aes(x=joined$`rMaf>20`, y=joined$`i.rMaf>20`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method1; MAF>20%; correlation coefficient=",round(cor(joined$`rMaf>20`, joined$`i.rMaf>20`), digits = 2))) +
    # xlab("raw") +ylab("method1") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")
    ) #+
    # theme(axis.line = element_line(color = 'black', size = 0.5, linetype = 'solid'))
    
joined$`rMaf>30` = as.numeric(joined$`rMaf>30`)       
joined$`i.rMaf>30` = as.numeric(joined$`i.rMaf>30`)      
p4 = ggplot(joined, aes(x=joined$`rMaf>30`, y=joined$`i.rMaf>30`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method1; MAF>30%; correlation coefficient=",round(cor(joined$`rMaf>30`, joined$`i.rMaf>30`), digits = 2))) +
  theme(plot.title = element_text(size = 5, face = "bold")) +
    # xlab("raw") +ylab("method1") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")) #+
    # theme(axis.line = element_line(color = 'black', size = 0.5, linetype = 'solid')) +
    # theme(axis.text.x = element_text(face="bold", color="black"), #, size=14
    #     axis.text.y = element_text(face="bold", color="black")) #, size=14
    
joined$`rMaf>40` = as.numeric(joined$`rMaf>40`)       
joined$`i.rMaf>40` = as.numeric(joined$`i.rMaf>40`)      
p5 = ggplot(joined, aes(x=joined$`rMaf>40`, y=joined$`i.rMaf>40`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method1; MAF>40%; correlation coefficient=",round(cor(joined$`rMaf>40`, joined$`i.rMaf>40`), digits = 2))) +
    # xlab("raw") +ylab("method1") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")
    ) #+
    # theme(axis.line = element_line(color = 'black', size = 0.5, linetype = 'solid'))

pdf(paste0(relatednessDir,"/raw_vs_minorDavid.pdf"))
par(mfrow=c(3,2))
print(p1); print(p2); print(p3); print(p4); print(p5)
dev.off()


#between raw and minorKarim
raw = as.data.table(raw); setkeyv(raw,c('iid1','iid2'))  
minorKarim = as.data.table(minorKarim); setkeyv(minorKarim,c('iid1','iid2'))     
joined = raw[minorKarim, nomatch=0]  
joined$`rMaf>0` = as.numeric(joined$`rMaf>0`)       
joined$`i.rMaf>0` = as.numeric(joined$`i.rMaf>0`)      
p6 = ggplot(joined, aes(x=joined$`rMaf>0`, y=joined$`i.rMaf>0`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method2; MAF>0%; correlation coefficient=",round(cor(joined$`rMaf>0`, joined$`i.rMaf>0`), digits = 2))) +
    xlab("raw") +ylab("method2") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")) 
    
joined$`rMaf>10` = as.numeric(joined$`rMaf>10`)       
joined$`i.rMaf>10` = as.numeric(joined$`i.rMaf>10`)      
p7 = ggplot(joined, aes(x=joined$`rMaf>10`, y=joined$`i.rMaf>10`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method2; MAF>10%; correlation coefficient=",round(cor(joined$`rMaf>10`, joined$`i.rMaf>10`), digits = 2))) +
    xlab("raw") + #ylab("method2") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")) 
    
joined$`rMaf>20` = as.numeric(joined$`rMaf>20`)       
joined$`i.rMaf>20` = as.numeric(joined$`i.rMaf>20`)      
p8 = ggplot(joined, aes(x=joined$`rMaf>20`, y=joined$`i.rMaf>20`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method2; MAF>20%; correlation coefficient=",round(cor(joined$`rMaf>20`, joined$`i.rMaf>20`), digits = 2))) +
    xlab("raw") + #ylab("method2") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")) 
    
joined$`rMaf>30` = as.numeric(joined$`rMaf>30`)       
joined$`i.rMaf>30` = as.numeric(joined$`i.rMaf>30`)      
p9 = ggplot(joined, aes(x=joined$`rMaf>30`, y=joined$`i.rMaf>30`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method2; MAF>30%; correlation coefficient=",round(cor(joined$`rMaf>30`, joined$`i.rMaf>30`), digits = 2))) +
    theme(plot.title = element_text(size = 5, face = "bold")) +
    xlab("raw") + #ylab("method2") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")) 
    
joined$`rMaf>40` = as.numeric(joined$`rMaf>40`)       
joined$`i.rMaf>40` = as.numeric(joined$`i.rMaf>40`)      
p10 = ggplot(joined, aes(x=joined$`rMaf>40`, y=joined$`i.rMaf>40`)) + 
    geom_point(shape=19, size=0.1) +
    geom_smooth(method=lm,  linetype="dashed",color="darkred", fill="blue") +
    ggtitle(paste0("raw vs method2; MAF>40%; correlation coefficient=",round(cor(joined$`rMaf>40`, joined$`i.rMaf>40`), digits = 2))) +
    xlab("raw") + #ylab("method2") +
    theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid")) 
pdf(paste0(relatednessDir,"/raw_vs_minorKarim.pdf"))
par(mfrow=c(3,2))
print(p6); print(p7); print(p8); print(p9); print(p10)
dev.off()

p = ggarrange(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10, 
          ncol = 5, nrow = 2)
print(p)


```

The results from the above showed that the raw data correlate more with the data from minor_David. It also shows that the highest correlations between the raw and minor_David are from MAF>0 and MAF>30. For the subsequent analysis, we choose to use the relatedness calculated from the raw data with MAF>30. We also recommend that when need is to use the data where the mixed genotypes are recoded based on minor_David.   

***

### **9. Convert relatedness data frame into matrix **    
In order to plot the relatedness between 1 isolate and others, the data needs to be converted into a matrix.  
&nbsp;&nbsp;&nbsp;&nbsp;**Function name:** _Create_relatedness_matrix.R_    
&nbsp;&nbsp;&nbsp;&nbsp;**Parameters:**    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the relatedness file_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the full path to the file sample metadata_  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the MAF cut-off_   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the path to the output folder_    
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- _the output file prefix_  
&nbsp;&nbsp;&nbsp;&nbsp;**Outputs:** _creates an `RDS` file with the prefix chosen by the user_     
&nbsp;&nbsp;&nbsp;&nbsp;**Example:**          
```{bash eval = FALSE}
Rscript Create_relatedness_matrix.R ./Results/RelatednessFolder/All_Relatedness_From_Raw.RDS ./Data/SampleMetadata.txt 0.3 ./Results/RelatednessFolder rMatrixFrom_Raw
```

###### **9.1. drawing the mean relatedness as a heatmap **   
```{r echo = FALSE} 
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(reshape2))
suppressPackageStartupMessages(library(data.table))

relatednessDir="/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/RelatednessFolder"
rMatrix = readRDS(paste0(relatednessDir,'/rMatrixFrom_Raw.RDS'))
meta=fread(paste0(relatednessDir,"/SampleMetadata.txt"))
loc = unique(meta$Location)
matIBDseg = matrix(0, nrow = length(loc), ncol = length(loc))
newOrder = c('Serrekunda','Brikama','Besse','Chogen','Farafenni','DongoroBa','Basse','SareWuro','Njayel','Bounkiling','Thies')
isolateNumber = c(36,230,17,8,157,11,117,62,80,59,92)

meta$SampleID = as.character(meta$SampleID)
rownames(matIBDseg) = newOrder
colnames(matIBDseg) = newOrder #rownames(matIBDseg) #= loc
for(i in 1:length(newOrder))
{
    t1 = newOrder[i]
    mm = meta[which(meta$Location==t1),]$SampleID
    replaceSep=function(x){gsub('-','.',x)}
    mm = unlist(lapply(mm, replaceSep))
    m1 = match(mm, rownames(rMatrix))
    m3 = match(mm, colnames(rMatrix))
    #m1 = which(meta$Location==t1)
    for(j in 1:length(loc))
    {
        t2=newOrder[j]
        mm = meta[which(meta$Location==t2),]$SampleID
        m2 = match(mm, colnames(rMatrix))
        m4 = match(mm, rownames(rMatrix))
        m5 = c(m1,m4); m6=c(m2,m3)
        target = rMatrix[m5, m6]
        matIBDseg[i,j] = mean(as.vector(target), na.rm = TRUE)
        
    }
}

meltedMatIBD = reshape2::melt(matIBDseg, na.rm = TRUE)
meltedMatIBD$Var1=as.factor(meltedMatIBD$Var1)
meltedMatIBD$Var2=as.factor(meltedMatIBD$Var2)
#meltedMatIBD$isolates = NA
#for(i in 1:length(newOrder))
#{
#    print(i)
#    meltedMatIBD[which(meltedMatIBD$Var1==newOrder[i] & meltedMatIBD$Var2==newOrder[i]),]$isolates = isolateNumber[i]
#}
#ggplot(data = meltedMatIBD, aes(Var2, Var1, fill = value))+
#    geom_tile(color = "white")+
#    scale_fill_gradient2(low = "red", high = "green", mid = "yellow",
#                         midpoint = 0.1, limit = c(min(meltedMatIBD$value),0.15), space = "Lab",name="mean IBD") +
#    theme_minimal()+
#    theme(axis.text.x = element_text(angle = 90, vjust = 1, size = 8, hjust = 1))+
#    coord_fixed()+
#    labs(title = "mean IBD") +
#    theme(
#        axis.title.x = element_blank(),
#        axis.title.y = element_blank(),
#        panel.grid.major = element_blank(),
#        panel.border = element_blank(),
#        panel.background = element_blank(),
#        axis.ticks = element_blank()) #+
    # geom_text(aes(Var2, Var1, label = isolates), color = "black", size = 4)


get_upper_tri = function(cormat)
{
    cormat[upper.tri(cormat)] = NA
    return(cormat)
}
upper_tri <- get_upper_tri(matIBDseg)
meltedMatIBD = reshape2::melt(upper_tri, na.rm = TRUE)
meltedMatIBD$isolates = NA
#for(i in 1:length(newOrder))
#{
#    if(i==11)
#        next
#    meltedMatIBD[which(meltedMatIBD$Var1==newOrder[i] & #meltedMatIBD$Var2==newOrder[i]),]$isolates = isolateNumber[i]
#}

meltedMatIBD$Var1=as.factor(meltedMatIBD$Var1)
meltedMatIBD$Var2=as.factor(meltedMatIBD$Var2)
p12 = ggplot(data = meltedMatIBD, aes(Var2, Var1, fill = value))+
    geom_tile(color = "white")+
    scale_fill_gradient2(low = "red", high = "green", mid = "yellow",
                         midpoint = 0.08, limit = c(min(meltedMatIBD$value),max(meltedMatIBD$value)), space = "Lab",name="mean") +
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 6, hjust = 1, colour = "black"))+
    theme(axis.text.y = element_text(size = 6, colour = "black"))+
    coord_fixed()+
    labs(title = "") +
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        legend.justification = c(1, 0),
        legend.position = c(1, 0.02),
        legend.direction = "vertical", 
        legend.title = element_text( size=6), 
        legend.text=element_text(size=6))   #+
    #geom_text(aes(Var2, Var1, label = isolates), color = "black", size = 4) 


```

##### **9.2. population structure**
```{r echo=FALSE}
suppressPackageStartupMessages(library(umap))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(ggplot2))

relatednessDir="/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/RelatednessFolder"
rMatrix = readRDS(paste0(relatednessDir,'/rMatrixFrom_Raw.RDS'))
meta=fread(paste0(relatednessDir,"/SampleMetadata.txt"))
modifier = function(x){gsub('-','.',x)}
meta$SampleID=lapply(meta$SampleID,modifier)

rMatrix[is.na(rMatrix)]=0
custom_config = umap.defaults
custom_config$n_components = 3
kk = umap(rMatrix, config = custom_config)
kk = kk$layout
m=match(rownames(kk), meta$SampleID)
kk = cbind(kk, meta$Location[m])
kk = as.data.frame(kk, stringsAsFactors = FALSE)
kk$V1=as.numeric(kk$V1)
kk$V2=as.numeric(kk$V2)
kk$V3=as.numeric(kk$V3)
kk$V4=as.factor(kk$V4)
rownames(kk)=NULL
ggplot(kk, aes(x=V1, y=V3, color=V4)) + 
  geom_point() + 
  scale_color_manual(name="Location",values=c("steelblue", "red",     "magenta","blue","black","green","yellow","gray","cyan","purple","orange")) +
  xlab("PC1") + ylab("PC2") +
  theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid"),
        legend.title = element_blank(), 
        legend.text=element_text(size=6)) 
```




###### **9.3. determination of the proportion of HRI between pairs of populations **   
```{r echo = FALSE}
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(officer))
suppressPackageStartupMessages(library(flextable))

relatednessDir="/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/RelatednessFolder"
raw = readRDS(paste0(relatednessDir,"/All_Relatedness_From_Raw.RDS"))
raw$`rMaf>30` = as.numeric(raw$`rMaf>30`)
hri = raw[which(raw$`rMaf>30`>=0.6),]

setkeyv(hri, c("site1","site2"))
nhri = hri[,.N,by=c("site1","site2")]
nhri$region1 = ""; nhri$region2=""
nhri[which(nhri$site1=="Basse" | nhri$site1=="SareWuro" | nhri$site1=="Njayel"),]$region1="east"
nhri[which(nhri$site1=="Farafenni" | nhri$site1=="DongoroBa" | nhri$site1=="Chogen"),]$region1="central"
nhri[which(nhri$site1=="Besse" | nhri$site1=="Brikama"),]$region1="west"
nhri[which(nhri$site1=="Bounkiling" | nhri$site1=="Thies"),]$region1="sen"

nhri[which(nhri$site2=="Basse" | nhri$site2=="SareWuro" | nhri$site2=="Njayel"),]$region2="east"
nhri[which(nhri$site2=="Farafenni" | nhri$site2=="DongoroBa" | nhri$site2=="Chogen"),]$region2="central"
nhri[which(nhri$site2=="Besse" | nhri$site2=="Brikama"),]$region2="west"
nhri[which(nhri$site2=="Bounkiling" | nhri$site2=="Thies"),]$region2="sen"
setkeyv(nhri, c("region1","region1"))
phri = nhri[,sum(N),by=c("region1","region2")]
phri$pAgainstHRI=round(phri$V1/sum(phri$V1), 3)


setkeyv(raw, c("site1","site2"))
rawByLoc = raw[,.N,by=c("site1","site2")]
#getting the proportion of HRI pairs between location
setkeyv(rawByLoc, c("site1","site2"))
setkeyv(nhri, c("site1","site2"))
nhri = nhri[rawByLoc, nomatch=0]
names(nhri)[3]="#HRI"; names(nhri)[6]="#totalPairs"; nhri=subset(nhri, select = -c(7,8))
nhri$pHRI = nhri$`#HRI`/nhri$`#totalPairs`
kable(nhri, caption="proportion of HRI between locations")
saveRDS(nhri,paste0(relatednessDir,'/Loc_PropHRI.RDS'))
# doc <- docx()
# doc <- addTitle(doc, "Between population relatedness")
# doc <- addFlexTable( doc, FlexTable(nhri))
# writeDoc(doc, file = paste0(relatednessDir,"/Between_pop_relatedness.docx"))


#getting the proportion of HRI between regions
rawByLoc$region1 = ""; rawByLoc$region2=""
rawByLoc[which(rawByLoc$site1=="Basse" | rawByLoc$site1=="SareWuro" | rawByLoc$site1=="Njayel"),]$region1="east"
rawByLoc[which(rawByLoc$site1=="Farafenni" | rawByLoc$site1=="DongoroBa" | rawByLoc$site1=="Chogen"),]$region1="central"
rawByLoc[which(rawByLoc$site1=="Besse" | rawByLoc$site1=="Brikama" | rawByLoc$site1=="Serrekunda"),]$region1="west"
rawByLoc[which(rawByLoc$site1=="Bounkiling" | rawByLoc$site1=="Thies"),]$region1="sen"

rawByLoc[which(rawByLoc$site2=="Basse" | rawByLoc$site2=="SareWuro" | rawByLoc$site2=="Njayel"),]$region2="east"
rawByLoc[which(rawByLoc$site2=="Farafenni" | rawByLoc$site2=="DongoroBa" | rawByLoc$site2=="Chogen"),]$region2="central"
rawByLoc[which(rawByLoc$site2=="Besse" | rawByLoc$site2=="Brikama" | rawByLoc$site2=="Serrekunda"),]$region2="west"
rawByLoc[which(rawByLoc$site2=="Bounkiling" | rawByLoc$site2=="Thies"),]$region2="sen"
setkeyv(rawByLoc, c("region1","region1"))
praw = rawByLoc[,sum(N),by=c("region1","region2")]
phri$pAgainstAll=round(phri$V1/c(25890,39109,42733,51316,84381,13912,3136,47726,5428), 5)
saveRDS(phri,paste0(relatednessDir,'/Region_PropHRI.RDS'))

names(phri)[3] = 'N'
kable(phri, caption="proportion of HRI between regions")

#%HRI between regions
raw$region1=""; raw$region2=""
raw[which(raw$site2=="Basse" | raw$site2=="SareWuro" | raw$site2=="Njayel"),]$region2="east"
raw[which(raw$site2=="Farafenni" | raw$site2=="DongoroBa" | raw$site2=="Chogen"),]$region2="central"
raw[which(raw$site2=="Besse" | raw$site2=="Brikama" | raw$site2=="Serrekunda"),]$region2="west"
raw[which(raw$site2=="Bounkiling" | raw$site2=="Thies"),]$region2="sen"

raw[which(raw$site1=="Basse" | raw$site1=="SareWuro" | raw$site1=="Njayel"),]$region1="east"
raw[which(raw$site1=="Farafenni" | raw$site1=="DongoroBa" | raw$site1=="Chogen"),]$region1="central"
raw[which(raw$site1=="Besse" | raw$site1=="Brikama" | raw$site1=="Serrekunda"),]$region1="west"
raw[which(raw$site1=="Bounkiling" | raw$site1=="Thies"),]$region1="sen"

raw$pairsRegion=paste0(raw$region1,'-',raw$region2)
raw$pairsRegion = as.factor(raw$pairsRegion)
hriByRegion = raw[which(raw$`rMaf>30`>=0.6)]
setkey(hriByRegion, "pairsRegion")
nhriByRegion = hriByRegion[,.N,by="pairsRegion"]
names(nhriByRegion)[2] = "#HRI"
numpairs = raw[,.N,by="pairsRegion"]
numpairs = numpairs[-9,]
m = match(nhriByRegion$pairsRegion, numpairs$pairsRegion)
nhriByRegion$`#totalPairs`= numpairs$N[m]
nhriByRegion$`%HRI` = nhriByRegion$`#HRI`/nhriByRegion$`#totalPairs`

kable(nhriByRegion, caption = "%HRI by regions")

# tt=raw[which(raw$hri=="HR"),]
# t=table(tt$pairsRegion)
# t = t[-3]
nhriByRegion=nhriByRegion[order(`%HRI`, decreasing = TRUE),]
# setkey(nhriByRegion, "%HRI")
# barplot(nhriByRegion$`%HRI`~nhriByRegion$pairsRegion, ylim=c(0,0.012))
ggplot(nhriByRegion, aes(x = reorder(pairsRegion, -`%HRI`), y = `%HRI`, fill = `%HRI`)) + 
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, face="bold", color="black", size = 5))+
  theme( axis.line = element_line(colour = "black", size = 0.5, linetype = "solid"))+
  xlab("") +
  theme(
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid"))


## drawing the proportion of HRI as a heatmap
matPropHRI = matrix(0, 11, 11)
rownames(matPropHRI) = rownames(matIBDseg)
colnames(matPropHRI) = colnames(matIBDseg)
for(i in 1:nrow(matPropHRI)){
  for(j in 1:ncol(matPropHRI)){
    m = nhri[which(nhri$site1==rownames(matPropHRI)[i] & nhri$site2==colnames(matPropHRI)[j]),]
    if(nrow(m)==0){
      m = nhri[which(nhri$site2==rownames(matPropHRI)[i] & nhri$site1==colnames(matPropHRI)[j]),]
      if(nrow(m)>0){
        matPropHRI[i,j] = m$pHRI
        matPropHRI[j,i] = m$pHRI
      }else{
        matPropHRI[i,j] = 0
      }
    }
  }
}

meltedMatHRI = reshape2::melt(matPropHRI, na.rm = TRUE)
meltedMatHRI$Var1=as.factor(meltedMatHRI$Var1)
meltedMatHRI$Var2=as.factor(meltedMatHRI$Var2)

get_lower_tri = function(cormat)
{
    cormat[lower.tri(cormat)] = NA
    return(cormat)
}
upper_tri = get_lower_tri(matPropHRI)
meltedMatHRI = reshape2::melt(upper_tri, na.rm = TRUE)
meltedMatHRI$isolates = NA

meltedMatHRI$Var1=as.factor(meltedMatHRI$Var1)
meltedMatHRI$Var2=as.factor(meltedMatHRI$Var2)
meltedMatHRI$percent = meltedMatHRI$value*100
p11 = ggplot(data = meltedMatHRI, aes(Var2, Var1, fill = value))+
    geom_tile(color = "white")+
    scale_fill_gradient2(low = "red", high = "green", mid = "yellow",
                         midpoint = 0.008, limit = c(min(meltedMatHRI$value),0.0165), space = "Lab",name="proportion of HRI") + #max(meltedMatHRI$value)
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 6, hjust = 1, colour = "black"))+
    theme(axis.text.y = element_text(size = 6, colour = "black"))+
    coord_fixed()+
    labs(title = "") +
    theme(
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        legend.justification = c(1, 0),
        legend.position = c(0.4, 0.4),
        legend.direction = "vertical", 
        legend.title = element_text( size=6), 
        legend.text=element_text(size=3))

p = ggarrange(p11,p12,
              labels = letters[1:2],
          ncol = 2, nrow = 1)
print(p)
```


***


### **10. spatial analysis (drawing connectivity using the proportion of HRI) **     
```{r echo=FALSE}  
suppressPackageStartupMessages(require("raster"))
suppressPackageStartupMessages(require("rgdal"))
suppressPackageStartupMessages(require("dplyr"))
suppressPackageStartupMessages(require("data.table"))
suppressPackageStartupMessages(require("knitr"))

relatednessDir="/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/RelatednessFolder"
relatednessTable = readRDS(paste0(relatednessDir,'/Loc_PropHRI.RDS'))
relatednessTable$LineWidth = relatednessTable$pHRI*150
gps = fread(paste0(relatednessDir,"/GPScoordinates.txt"))
gmb = getData(name = "GADM", country = "GMB", level=0)
sen = getData(name = "GADM", country = "SEN", level=0) 

# cross-border spatial analysis
senegam = gps[which(gps$Village!='Brikama' & gps$Village!='Chogen' & gps$Village!='Serrekunda' & gps$Village!='DongoroBa' & gps$Village!='Farafenni' & gps$Village!='Velingara' & gps$Village!='SareSeedy'),]
plot(sen)
points(x=senegam$longitude, y=senegam$latitude, pch=19, cex=1.5, col=c('red','red','black','green','green','green')) 
crossBorder1 = relatednessTable[which(relatednessTable$site1=='Thies' | relatednessTable$site1=='Bounkiling'), ]
crossBorder2 = relatednessTable[which(relatednessTable$site2=='Thies' | relatednessTable$site2=='Bounkiling'), ]
crossBorder = rbind(crossBorder1, crossBorder2)

bklg_th = fread(paste0(relatednessDir,"/SiteConnectors/Bounkiling_Thies.csv"))
r = crossBorder[which(crossBorder$site1=='Thies' & crossBorder$site2=='Bounkiling'),]$LineWidth
lines(x=bklg_th$long[2000:4002], y=bklg_th$lat[2000:4002], col='darkblue', lwd=r)

bklg_besse = fread(paste0(relatednessDir,"/SiteConnectors/Bounkiling_Besse.csv"))
r = crossBorder[which(crossBorder$site1=='Besse' & crossBorder$site2=='Bounkiling'),]$LineWidth
lines(x=bklg_besse$long[1:2000], y=bklg_besse$lat[1:2000], col='darkblue', lwd=r)

th_besse = fread(paste0(relatednessDir,"/SiteConnectors/Thies_Besse.csv"))
r = crossBorder[which(crossBorder$site1=='Besse' & crossBorder$site2=='Thies'),]$LineWidth
lines(x=th_besse$long[2000:4002], y=th_besse$lat[2000:4002], col='darkblue', lwd=r)

th_basse = fread(paste0(relatednessDir,"/SiteConnectors/Thies_Basse.csv"))
r = crossBorder[which(crossBorder$site1=='Basse' & crossBorder$site2=='Thies'),]$LineWidth
lines(x=th_basse$long[1:2000], y=th_basse$lat[1:2000], col='darkblue', lwd=r)

th_njayel = fread(paste0(relatednessDir,"/SiteConnectors/Thies_Njayel.csv"))
r = crossBorder[which(crossBorder$site1=='Njayel' & crossBorder$site2=='Thies'),]$LineWidth
lines(x=th_njayel$long[2000:4002], y=th_njayel$lat[2000:4002], col='darkblue', lwd=r)

th_sw = fread(paste0(relatednessDir,"/SiteConnectors/Thies_SareWuro.csv"))
r = crossBorder[which(crossBorder$site1=='SareWuro' & crossBorder$site2=='Thies'),]$LineWidth
lines(x=th_sw$long[1:2000], y=th_sw$lat[1:2000], col='darkblue', lwd=r)


# spatial analysis within gambia
withiGambia1 = relatednessTable[which(relatednessTable$site1!='Thies' & relatednessTable$site1!='Bounkiling'), ]
withiGambia2 = withiGambia1[which(withiGambia1$site2!='Thies' & withiGambia1$site2!='Bounkiling'), ]
#withiGambia = distinct(rbind(withiGambia1, withiGambia2))
gambia = gps[which(gps$Village!='Thies' & gps$Village!='Bounkiling' & gps$Village!='Serrekunda'),]


plot(gmb)
points(x=gambia$longitude, y=gambia$latitude, pch=19, cex=1.5, col=c('black','black','blue','blue','green','green','green','blue')) 

#for chogen
chogenAllFiles = list.files(path = paste0(relatednessDir,"/SiteConnectors"), pattern = "Chogen_", full.names = TRUE)
for(i in 1:length(chogenAllFiles))
{
    if(i==6 | i==8) #| i==8
    {
        s = gsub('.csv','',basename(chogenAllFiles[i]))
        s = unlist(strsplit(s,'_'))
        t = fread(chogenAllFiles[i])
        r = withiGambia2[which(withiGambia2$site1==s[1] & withiGambia2$site2==s[2]),]$LineWidth
        if(length(r) == 0)
            r = withiGambia2[which(withiGambia2$site1==s[2] & withiGambia2$site2==s[1]),]$LineWidth
        if(i==6)
          lines(x=t$long[2000:4002], y=t$lat[2000:4002], col='steelblue', lwd=r)
        else
            lines(x=t$long[1:2000], y=t$lat[1:2000], col='darkblue', lwd=r)
    }
}

#for Basse
basseAllFiles = list.files(path = paste0(relatednessDir,"/SiteConnectors"), pattern = "Basse_", full.names = TRUE)
for(i in 1:length(basseAllFiles))
{
    if( i==8 | i==10 ) #| i==2 | i==5 | i==11 | i==7
    {
        s = gsub('.csv','',basename(basseAllFiles[i]))
        s = unlist(strsplit(s,'_'))
        t = fread(basseAllFiles[i])
        r = withiGambia2[which(withiGambia2$site1==s[1] & withiGambia2$site2==s[2]),]$LineWidth
        if(length(r) == 0)
            r = withiGambia2[which(withiGambia2$site1==s[2] & withiGambia2$site2==s[1]),]$LineWidth
        lines(x=t$long[1:2000], y=t$lat[1:2000], col='darkblue', lwd=r)
    }
}

#for Besse
besseAllFiles = list.files(path = paste0(relatednessDir,"/SiteConnectors"), pattern = "Besse_", full.names = TRUE)
for(i in 1:length(besseAllFiles))
{
    if(i==5 | i==6 | i==8 | i==10) #| i==8 | i==4
    {
        s = gsub('.csv','',basename(besseAllFiles[i]))
        s = unlist(strsplit(s,'_'))
        t = fread(besseAllFiles[i])
        r = withiGambia2[which(withiGambia2$site1==s[1] & withiGambia2$site2==s[2]),]$LineWidth
        if(length(r) == 0)
            r = withiGambia2[which(withiGambia2$site1==s[2] & withiGambia2$site2==s[1]),]$LineWidth
        else
            lines(x=t$long[2000:40002], y=t$lat[2000:40002], col='darkblue', lwd=r)
    }
}

#for Brikama
brikamaAllFiles = list.files(path = paste0(relatednessDir,"/SiteConnectors"), pattern = "Brikama_", full.names = TRUE)
for(i in 1:length(brikamaAllFiles))
{
    if(i==1 | i==2 | i==5 | i==6 | i==7 | i==8)
    {
        s = gsub('.csv','',basename(brikamaAllFiles[i]))
        s = unlist(strsplit(s,'_'))
        t = fread(brikamaAllFiles[i])
        r = withiGambia2[which(withiGambia2$site1==s[1] & withiGambia2$site2==s[2]),]$LineWidth
        if(length(r) == 0)
            r = withiGambia2[which(withiGambia2$site1==s[2] & withiGambia2$site2==s[1]),]$LineWidth
        if( i==7)
            lines(x=t$long[2000:4002], y=t$lat[2000:4002], col='darkblue', lwd=r)
        if(i==5 | i==6)
            lines(x=t$long[1:2000], y=t$lat[1:2000], col='darkblue', lwd=r)
        if(i==1)
            lines(x=t$long[2000:4002], y=t$lat[2000:4002], col='darkblue', lwd=r)
        else
            lines(x=t$long[2000:4002], y=t$lat[2000:4002], col='darkblue', lwd=r)
    }
    
}

#for dongoroBa
dongoroBaAllFiles = list.files(path = paste0(relatednessDir,"/SiteConnectors"), pattern = "DongoroBa_", full.names = TRUE)
for(i in 1:length(dongoroBaAllFiles))
{
    if(i==8)  #| i==10 | i==1 | i==11 | i==7 i==8 |
    {
        s = gsub('.csv','',basename(dongoroBaAllFiles[i]))
        s = unlist(strsplit(s,'_'))
        t = fread(dongoroBaAllFiles[i])
        r = withiGambia2[which(withiGambia2$site1==s[1] & withiGambia2$site2==s[2]),]$LineWidth
        if(length(r) == 0)
            r = withiGambia2[which(withiGambia2$site1==s[2] & withiGambia2$site2==s[1]),]$LineWidth
        lines(x=t$long[1:2000], y=t$lat[1:2000], col='darkblue', lwd=r)
    }
}

#for Njayel
njayelAllFiles = list.files(path = paste0(relatednessDir,"/SiteConnectors"), pattern = "Njayel_", full.names = TRUE)
for(i in 1:length(njayelAllFiles))
{
    if(i==10)  
    {
        s = gsub('.csv','',basename(njayelAllFiles[i]))
        s = unlist(strsplit(s,'_'))
        t = fread(njayelAllFiles[i])
        r = withiGambia2[which(withiGambia2$site1==s[1] & withiGambia2$site2==s[2]),]$LineWidth
        if(length(r) == 0)
            r = withiGambia2[which(withiGambia2$site1==s[2] & withiGambia2$site2==s[1]),]$LineWidth
        # if(i==6)
            lines(x=t$long[2000:4002], y=t$lat[2000:4002], col='darkblue', lwd=r)
        # else if(i==1)
        #     lines(x=t$long[1:2000], y=t$lat[1:2000], col='magenta', lwd=r)
        # else
        #     lines(x=t$long[2000:4002], y=t$lat[2000:4002], col='cyan', lwd=r)
    }
}
```

***
  
### **11. Relatedness in eastern Gambia **  
```{r echo=FALSE}
suppressPackageStartupMessages(require(data.table))
suppressPackageStartupMessages(require(chorddiag))#devtools::install_github("mattflor/chorddiag")
suppressPackageStartupMessages(require(migest))
suppressPackageStartupMessages(require(arcdiagram))#devtools::install_github('gastonstat/arcdiagram')
suppressPackageStartupMessages(require(edgebundleR))
suppressPackageStartupMessages(require(igraph))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(tidyverse))

relatednessDir="/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/RelatednessFolder"
rMatrix = readRDS(paste0(relatednessDir,'/rMatrixFrom_Raw.RDS'))
meta=fread(paste0(relatednessDir,"/SampleMetadata.txt"))
modifier = function(x){gsub('-','.',x)}
meta$SampleID=lapply(meta$SampleID,modifier)
rMatrix[is.na(rMatrix)]=0

easterGambia1 = raw[which(raw$site1=="Basse" | raw$site1=="Njayel" | raw$site1=="SareWuro"),]
easterGambia2 = easterGambia1[which(easterGambia1$site2=="Basse" | easterGambia1$site2=="Njayel" | easterGambia1$site2=="SareWuro"),]
rm(easterGambia1)
# easterGambia = easterGambia2[which(as.numeric(easterGambia2$`rMaf>30`)>0.4),]

gpsEast = readRDS(paste0(relatednessDir,'/EasternGambiaGPS.RDS'))
gpsEast = as.data.table(gpsEast)

connect = subset(easterGambia2, select=c(1,2,6))
names(connect) = c('from','to','value')
connect$value = as.numeric(connect$value)
# connect$value = 1
setkey(connect,"from")
setkey(gpsEast, "SampleID")
connect1 = connect[gpsEast, nomatch=0]
connect2 = subset(connect1, select=c(1,2,3,6,7,8,9))
names(connect2)[4:7]=c("villageCode1","compoundCode1","lat1","long1")
setkey(connect2,NULL); setkey(connect2,"to"); rm(connect, connect1)
connect3 = connect2[gpsEast, nomatch=0]
connect2 = subset(connect3, select=c(1:7,10:13))
names(connect2)[8:11]=c("villageCode2","compoundCode2","lat2","long2")
connect2 = connect2[which(connect2$value>0.2),]
connect2 = as.data.table(connect2)
setkeyv(connect2, c("villageCode1","villageCode2"))
npEast = connect2[,.N,by=c("villageCode1","villageCode2")]
kable(npEast, caption="#pairs in eastern Gambia with GPS data")
rm(connect3)
connect = subset(connect2, select=c(1:3))

#4. calculate the number of connection per sample
c( as.character(connect$from), as.character(connect$to)) %>%
    as_tibble() %>%
    group_by(value) %>%
    summarize(n=n()) -> coauth
colnames(coauth) <- c("name", "n")
coauth=as.data.table(coauth)
tmp=subset(connect2, select=c(1,4)); names(tmp)=c('iid','villageCode')
tmp1=subset(connect2, select=c(2,8)); names(tmp1)=c('iid','villageCode')
tmp = rbind(tmp,tmp1); rm(tmp1)
m = match(coauth$name, tmp$iid)
coauth$group=tmp$villageCode[m]

#8. Reorder dataset obtained after filtration and make the graph
coauth$grp = 0
coauth[which(coauth$group=='J'),]$grp=1
coauth[which(coauth$group=='K'),]$grp=2
coauth[which(coauth$group=='L'),]$grp=3
coauth[which(coauth$group=='M'),]$grp=4
coauth=subset(coauth, select = -3)
coauth = arrange(coauth, grp)
connect_difVill = connect #select links 

#10. re-ordering the connect data frame
for(i in 1:nrow(coauth)){
    if(i==1){
        connect_ForPlot = connect_difVill[which(connect_difVill$from==coauth$name[i]),]
    }else{
        if(nrow( connect_difVill[which(connect_difVill$from==coauth$name[i]),]) > 0){
            connect_ForPlot = rbind(connect_ForPlot, connect_difVill[which(connect_difVill$from==coauth$name[i]),])
        }
    }
}

connect_ForPlot$loc1=NA; connect_ForPlot$loc2=NA
m = match(connect_ForPlot$from, coauth$name)
connect_ForPlot$loc1 = coauth$grp[m]
m = match(connect_ForPlot$to, coauth$name)
connect_ForPlot$loc2 = coauth$grp[m]
connect_ForPlot$from = paste0(connect_ForPlot$loc1,'.',connect_ForPlot$from)
connect_ForPlot$to = paste0(connect_ForPlot$loc2,'.',connect_ForPlot$to)
connect_ForPlot$colour="green"
connect_ForPlot[which(connect_ForPlot$loc1 != connect_ForPlot$loc2),]$colour="blue"
rel2 = subset(connect_ForPlot, select = c(1:2))

coauth1 = coauth
coauth1$name = paste0(coauth1$grp,'.',coauth1$name)

#11. drawing the graph
gg = graph.data.frame(rel2, directed=F, vertices=coauth1)
edge.start = ends(gg, es=E(gg), names = F)[,1]
edge.col = V(gg)$color[edge.start]

clr = as.factor(V(gg)$grp)
levels(clr) =  c("salmon", "orange", "lightskyblue", 'gray')
V(gg)$color = as.character(clr)
V(gg)$size = degree(gg)*1
E(gg)$width <- 5*connect_ForPlot$value
E(gg)$color = connect_ForPlot$colour
plot(gg, layout = layout.circle, vertex.label=NA)

edgebundle( gg, tension = 0.7 ) -> eb
eb

```
Colour code in the link plots:  
Village J: salmon  
Village K: gray   
Village L: lightskyblue   
Village M: orange  
links between isolates from the same village: blue  
links between isolates from different villages: black   


***
  
### **12. stats about the eastern Gambia **  
```{r echo=FALSE}
suppressPackageStartupMessages(require("ggpubr"))
suppressPackageStartupMessages(require("quantreg"))

#number of isolates from the 4 villages
kable(table(coauth1$grp), caption="#isolates from the 4 villages (with r>=0.2)\
1=J, 2=K, 3=L, 4=M")

#comparing median IBD between same and different village
connect2$village="same"
connect2[which(connect2$villageCode1!=connect2$villageCode2),]$village="different"
connect2$village = as.factor(connect2$village)
median(connect2[which(connect2$village=="same"),]$value)
median(connect2[which(connect2$village=="different"),]$value)
wilcox.test(value ~ village, data = connect2,exact = FALSE)

ggboxplot(connect2, x = "village", y = "value", 
          color = "village", palette = c("orange", "gray"),
          ylab = "relatedness", xlab = "villages",
          font.tickslab = c(14,"bold", "black")) +
  theme(legend.position = "none",
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid"))

#identifying pairs from the same village
sameVillage = connect2[which(connect2$villageCode1==connect2$villageCode2),]
sameVillage$compound = "different"
sameVillage[which(sameVillage$compoundCode1==sameVillage$compoundCode2),]$compound = "same"
sameVillage$compound = as.factor(sameVillage$compound)
sameVillage$compound=as.factor(sameVillage$compound)
median(sameVillage[which(sameVillage$compound=="same"),]$value)
median(sameVillage[which(sameVillage$compound=="different"),]$value)
wilcox.test(value ~ compound, data = sameVillage,exact = FALSE)

ggboxplot(sameVillage, x = "compound", y = "value", 
          color = "compound", palette = c("orange", "gray"),
          ylab = "relatedness", xlab = "compound",
          font.tickslab = c(14,"bold", "black")) +
  theme(legend.position = "none",
        axis.text.x = element_text(face="plain", color="black", size=6),
        axis.text.y = element_text(face="plain", color="black", size=6),
        axis.line = element_line(colour = "black", size = 0.5, linetype = "solid"))

sameVillage$hri="No"
sameVillage[which(sameVillage$value>=0.6),]$hri="Yes"
chisq.test(table(sameVillage$compound, sameVillage$hri))
t=table(sameVillage$compound, sameVillage$hri)
t[1,]=t[1,]/sum(t[1,])
t[2,]=t[2,]/sum(t[,])
kable(t, caption = "%HRI in pairs from same village vs different village")
chisq.test(t)

#calculating physical distance between pairs of isolates from same village
sameVillage$lat1=as.numeric(sameVillage$lat1)
sameVillage$lat2=as.numeric(sameVillage$lat2)
sameVillage$long1=as.numeric(sameVillage$long1)
sameVillage$long2=as.numeric(sameVillage$long2)
for(j in 1:nrow(sameVillage))
{
    deltaLong=deltaLat=a=b=b2=c=d=var1=var2=0
    p = pi/180
    deltaLong = (sameVillage$long2[j]-sameVillage$long1[j])*p
    deltaLat = (sameVillage$lat2[j]-sameVillage$lat1[j])*p
    a = sin(deltaLat/2.0)
    b = sin(deltaLong/2.0)
    b2 = b^2
    c = cos(sameVillage$lat1[j]*p)
    d = cos(sameVillage$lat2[j]*p)
    var1 = a^2 + c*d*b2
    var2 = 2*atan2(sqrt(var1), sqrt(1-var1))
    sameVillage$distance[j] = round(6370000*var2, digits = 0) #3956 in miles; 6370 in km, 6370000 in meters
}
model.q = rq(value ~ distance,data = sameVillage,tau = 0.5)  #SameCompound
summary(model.q)
model.null = rq(value ~ 1,data = sameVillage,tau = 0.5)
anova(model.q, model.null)

#transmission dynamic in those from same village
sameVillage$rInterval = ""
sameVillage[which(sameVillage$value>=0.2 & sameVillage$value<0.4),]$rInterval='[0.2-0.4['
sameVillage[which(sameVillage$value>=0.4 & sameVillage$value<0.6),]$rInterval='[0.4-0.6['
sameVillage[which(sameVillage$value>=0.6 & sameVillage$value<0.8),]$rInterval='[0.6-0.8['
sameVillage[which(sameVillage$value>=0.8),]$rInterval='[0.8-1]'

t = as.matrix(table(sameVillage$compound, sameVillage$rInterval))
rs = rowSums(t)
t[1,] = t[1,]/rs[1]
t[2,] = t[2,]/rs[2]
kable(t, caption = "relatedness by interval")

```

## 13. Drawing the sampling sites on a map

```{r echo=FALSE}
suppressPackageStartupMessages(require("raster"))
suppressPackageStartupMessages(require("rgdal"))
suppressPackageStartupMessages(require(data.table))
suppressPackageStartupMessages(require(leaflet))
suppressPackageStartupMessages(require(htmltools))
locations = fread("/Users/km28/Documents/Karim/Karim/Gitlab/Transmission/Malaria-transmission-analysis/Data/GPScoordinates.txt")
sampleNumber = c(259,107,65,17,8,11,86,76,153,267,46)
loc = as.data.frame(cbind(locations[,1],locations[,2], locations[,3], sampleNumber))
names(loc)=c('Lat','Long','name','sampleNumber')
icons = awesomeIcons(
  icon = 'ios-close',
  iconColor = 'black',
  library = 'ion'
)

#----- drawing collection sites  
m=leaflet(loc, options = leafletOptions(zoomControl = FALSE)) %>% 
  addAwesomeMarkers(~Long, ~Lat,icon=icons,label = ~htmlEscape(name), labelOptions = labelOptions(noHide = T,textOnly = T, direction = 'top', style=list("color"="red", weight = 1, "font-size" = "12px"))) %>% 
  addTiles(urlTemplate = "http://mt0.google.com/vt/lyrs=m&hl=en&x={x}&y={y}&z={z}&s=Ga", attribution = 'Google') #%>% 
  #addProviderTiles('Esri.NatGeoWorldMap') #%>%  #MtbMap  CartoDB.PositronNoLabels

m 
```






